<!doctype html>
<title>Transforms reftest viewer</title>
<base href="ref-2d/">
<style>iframe { overflow:hidden; height:600px;width:800px }</style>
<p><input type=button id=prev value=Prev onclick="prev()" disabled>
<input type=button id=next value=Next onclick="next()" disabled>
<p>Test: <span id=testname>(loading)</span>
<p>Ref: <span id=refname>(loading)</span>
<p><label><input type=radio name=toggle id=matches onclick="reset()" disabled checked> Matches</label>
<label><input type=radio name=toggle id=mismatches onclick="reset()" disabled> Mismatches</label>
<script>
"use strict";
var testNames = [
	"abspos-1a.html",
	"abspos-1b.html",
	"abspos-1c.html",
	"abspos-1d.html",
	"abspos-1e.html",
	"compound-1a.html",
	// FIXME: Uncomment when
	// https://www.w3.org/Bugs/Public/show_bug.cgi?id=15755 is fixed, and add a
	// separate reftest
	//"descendant-1.html",
	// TODO: Uncomment when I figure out how to handle dynamic setting of
	// prefixes
	//"dynamic-inherit-1.html",
	"iframe-1.html",
	"matrix-1a.html",
	"matrix-2a.html",
	"matrix-3a.html",
	"matrix-4a.html",
	"matrix-5a.html",
	"matrix-6a.html",
	"matrix-7a.html",
	"origin-1a.html",
	"origin-1b.html",
	"origin-2a.html",
	"origin-2b.html",
	"origin-2c.html",
	"origin-name-1a.html",
	"origin-name-1b.html",
	"origin-name-2a.html",
	"origin-name-2b.html",
	"origin-name-2c.html",
	"origin-name-3a.html",
	"origin-name-3b.html",
	"percent-1a.html",
	"percent-1b.html",
	"percent-1c.html",
	"percent-1d.html",
	"percent-1e.html",
	"percent-1f.html",
	"percent-1g.html",
	"propagate-inherit-boolean.html",
	"rotate-1a.html",
	"rotate-1b.html",
	"rotate-1c.html",
	"rotate-1d.html",
	"rotate-1e.html",
	"rotate-1f.html",
	"rotate-2a.html",
	"scale-1a.html",
	"scale-1b.html",
	"scale-percent-1.html",
	"scalex-1.html",
	"scaley-1.html",
	"singular-1a.html",
	"skew-1a.html",
	"skew-1b.html",
	"skew-2a.html",
	"stresstest-1.html",
	"translate-1a.html",
	"translate-1b.html",
	"translate-1c.html",
	"translate-1d.html",
	"translate-1e.html",
	"translatex-1a.html",
	"translatex-1b.html",
	"translatex-1c.html",
	"translatex-1d.html",
	"translatex-1e.html",
	"translatex-2.html",
	"translatey-1a.html",
	"translatey-1b.html",
	"translatey-1c.html",
	"translatey-1d.html",
	"translatey-1e.html",
	"translatey-2.html",
];

var prefix = "transform" in document.body.style ? ""
	: "msTransform" in document.body.style ? "-ms-"
	: "MozTransform" in document.body.style ? "-moz-"
	: "webkitTransform" in document.body.style ? "-webkit-"
	: "OTransform" in document.body.style ? "-o-"
	: "";

// IE9 seems not to support relative URLs in <base href>
document.querySelector("base").href =
	String(location).replace(/[^\/]*$/, "ref-2d/");

testNames.forEach(function(testName, i) {
	var test = document.createElement("iframe");
	test.onload = testLoaded;
	test.src = testName;
	test.style.display = "none";
	test.setAttribute("data-test", i);
	document.body.insertBefore(test, document.querySelector("p"));
});

function testLoaded(e) {
	var test = e.target;
	var matches = test.contentDocument.querySelectorAll("link[rel=match]");
	if (matches.length) {
		test.setAttribute("data-matches", "");
	}
	for (var i = 0; i < matches.length; i++) {
		var ref = document.createElement("iframe");
		ref.onload = refLoaded;
		ref.src = matches[i].getAttribute("href");
		ref.style.display = "none";
		ref.setAttribute("data-test", test.getAttribute("data-test"));
		ref.setAttribute("data-ref-match", i);
		ref.setAttribute("data-not-loaded", "");
		document.body.insertBefore(ref, document.querySelector("p"));
	}

	var mismatches = test.contentDocument.querySelectorAll("link[rel=mismatch]");
	if (mismatches.length) {
		test.setAttribute("data-mismatches", "");
	}
	for (var i = 0; i < mismatches.length; i++) {
		var ref = document.createElement("iframe");
		ref.onload = refLoaded;
		ref.src = mismatches[i].getAttribute("href");
		ref.style.display = "none";
		ref.setAttribute("data-test", test.getAttribute("data-test"));
		ref.setAttribute("data-ref-mismatch", i);
		ref.setAttribute("data-not-loaded", "");
		document.body.insertBefore(ref, document.querySelector("p"));
	}

	prefixStyles(test.contentDocument);
}

function refLoaded(e) {
	prefixStyles(e.target.contentDocument);
	e.target.removeAttribute("data-not-loaded");
	conditionalLoadHandler();
}

function prefixStyles(doc) {
	[].forEach.call(doc.querySelectorAll("[style]"), function(el) {
		el.setAttribute("style",
			el.getAttribute("style").replace(/transform/g, prefix + "transform")
		);
	});
	[].forEach.call(doc.querySelectorAll("style"), function(el) {
		el.textContent = el.textContent
			.replace(/transform/g, prefix + "transform");
	});
	[].forEach.call(doc.querySelectorAll("iframe"), function(el) {
		prefixStyles(el.contentDocument);
	});
}

function reset() {
	tests[testIdx].style.display = "none";
	refs[testIdx][refIdx].style.display = "none";
	testIdx = 0;
	refIdx = 0;
	if (document.querySelector("#matches").checked) {
		tests = matchTests;
		refs = matchRefs;
	} else {
		tests = mismatchTests;
		refs = mismatchRefs;
	}
	document.querySelector("#testname").textContent = tests[testIdx].getAttribute("src");
	document.querySelector("#refname").textContent = refs[testIdx][refIdx].getAttribute("src");
	document.querySelector("#prev").disabled = true;
	document.querySelector("#next").disabled = false;
	return true;
}

function next() {
	document.querySelector("#prev").disabled = false;
	tests[testIdx].style.display = "none";
	refs[testIdx][refIdx].style.display = "none";
	if (refIdx + 1 < refs[testIdx].length) {
		refIdx++;
	} else {
		testIdx++;
		refIdx = 0;
	}

	if (testIdx == tests.length - 1
	&& refIdx == refs[testIdx].length - 1) {
		document.querySelector("#next").disabled = true;
	}
	document.querySelector("#testname").textContent = tests[testIdx].getAttribute("src");
	document.querySelector("#refname").textContent = refs[testIdx][refIdx].getAttribute("src");
	tests[testIdx].style.display = "";
}

function prev() {
	document.querySelector("#next").disabled = false;
	tests[testIdx].style.display = "none";
	refs[testIdx][refIdx].style.display = "none";
	if (refIdx > 0) {
		refIdx--;
	} else {
		testIdx--;
		refIdx = refs[testIdx].length - 1;
	}
	if (testIdx == 0 && refIdx == 0) {
		document.querySelector("#prev").disabled = true;
	}
	document.querySelector("#testname").textContent = tests[testIdx].getAttribute("src");
	document.querySelector("#refname").textContent = refs[testIdx][refIdx].getAttribute("src");
	tests[testIdx].style.display = "";
}

var tests = null, refs = [];
var matchTests = null, matchRefs = [];
var mismatchTests = null, mismatchRefs = [];
var testIdx = 0, refIdx = 0;

// WebKit and Opera don't delay the load event for the ref iframes, it seems
function conditionalLoadHandler() {
	if (document.readyState != "complete") {
		return;
	}
	if ([].some.call(document.querySelectorAll("iframe"), function(iframe) {
		return iframe.hasAttribute("data-not-loaded");
	})) {
		return;
	}
	if (tests !== null) {
		throw "This should be impossible: conditionalLoadHandler run multiple times";
	}

	matchTests = document.querySelectorAll("[data-matches]");
	for (var i = 0; i < matchTests.length; i++) {
		matchRefs.push(document.querySelectorAll("[data-test='" +
			matchTests[i].getAttribute("data-test") + "']"
			+ "[data-ref-match]"));
	}

	mismatchTests = document.querySelectorAll("[data-mismatches]");
	for (var i = 0; i < mismatchTests.length; i++) {
		mismatchRefs.push(document.querySelectorAll("[data-test='" +
			mismatchTests[i].getAttribute("data-test") + "']"
			+ "[data-ref-mismatch]"));
	}

	tests = matchTests;
	refs = matchRefs;

	setInterval(function() {
		if (tests[testIdx].style.display) {
			tests[testIdx].style.display = "";
			refs[testIdx][refIdx].style.display = "none";
		} else {
			tests[testIdx].style.display = "none";
			refs[testIdx][refIdx].style.display = "";
		}
	}, 100);

	document.querySelector("#matches").disabled = false;
	document.querySelector("#mismatches").disabled = false;

	reset();
}

window.onload = conditionalLoadHandler;
</script>
