<!DOCTYPE html>
<html>
<head>
    <title id='desc'>IDBCursor.delete() - index - attempt to remove a record in an inactive transaction </title>
    <script type="text/javascript" src="support.js"></script>
    <script src="http://w3c-test.org/resources/testharness.js"></script>
    <script src="http://w3c-test.org/resources/testharnessreport.js"></script>
    <script type="text/javascript">
            var objectStoreName = "objectstore";
            var indexName = "index";
            var records = [ { pKey: "primaryKey_0", iKey: "indexKey_0" },
                            { pKey: "primaryKey_1", iKey: "indexKey_1" }];
            var count = records.length;
            var db = null;
            
            var t = async_test(document.title); 
            Initialize();
            function RunTest()
            {
                try
                {
                    var rqOpen = window.indexedDB.open(databaseName);
                    rqOpen.onsuccess = function(event)
                    {
                        try
                        {
                            db = event.target.result;
                            db.onerror = FailTest;
                            var rqVersionChange = db.setVersion("1");
                            rqVersionChange.onsuccess = function(event)
                            {
                                try
                                {
                                    var objStore = db.createObjectStore(objectStoreName, {keyPath:"pKey"});
                                    var index = objStore.createIndex(indexName, "iKey");
                                    for(var i = 0; i < records.length; i++)
                                    {
                                        objStore.add(records[i]);
                                    }
                                    var rqCursor = index.openCursor();
                                    rqCursor.onsuccess = function (event)
                                    {
                                        var cursor = event.target.result;
                                        if(cursor)
                                        {
                                            window.cursor = cursor;
                                        }
                                        else
                                        {
                                            FailTest();
                                        }
                                    }
                                    event.target.transaction.oncomplete = function (event)
                                    {
                                        try
                                        {
                                            window.cursor.delete();
                                        }
                                        catch(ex)
                                        {
                                            if(ex.code == IDBDatabaseException.TRANSACTION_INACTIVE_ERR)
                                            {
                                                PassTest();
                                            }
                                            else
                                            {
                                                FailTest();
                                            }
                                        }
                                    };
                                }
                                catch (ex)
                                {
                                    FailTest();
                                }
                            };
                        }
                        catch (ex)
                        {
                            FailTest();
                        }
                    };
                    rqOpen.onerror = FailTest;
                }
                catch (ex)
                {
                    FailTest();
                }
            }
    </script>
</head>
<body>
    <div id="log"></div>
</body>
</html>
